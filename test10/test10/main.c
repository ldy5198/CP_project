#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <conio.h>
#include "func.h"

#define MAX_WEIGHT 2000
#define MAX_FLOORS 20

const char* cardNames[] = {
    "???? ????",
    "???? ????",
    "???? ?? ????? ????",
    "?? ?????",
    "??? ???",
    "???? ???? ?ея?",
    "???? ?ещ? ???? ??? ?ещ? ????"
};

void showMainMenu() {
    printf("\n\n\n");
    printf("=====================================\n");
    printf("         ? ?????? ????\n");
    printf("=====================================\n");
    printf("    1. ???? ????\n");
    printf("    2. ???? ??? ????\n");
    printf("    3. ????\n");
    printf("=====================================\n");
    printf("?????????: ");
}

void playGame(Player* player) {
    CardFunction cardDeck[] = {
        decreaseWeight,
        increaseWeight,
        resetToPreviousFloorWeight,
        skipFloor,
        applyBalloonEffect,
        randomWeight,
        randomMultiple
    };

    while (player->currentFloor <= MAX_FLOORS && player->currentWeight > 0) {
        int weightLimit = MAX_WEIGHT - ((player->currentFloor - 1) * 100);

        if (player->currentWeight > weightLimit) {
            printf("????? ??? ????? %d???? ???? ?? ???????. ???? ????!\n", player->currentFloor);
            return;
        }

        printf("\n%d???? ??????????. ??? ??? ????: %dkg\n", player->currentFloor, weightLimit);
        printf("???? ????: %dkg\n", player->currentWeight);

        CardFunction selectedCards[3];
        const char* selectedDescriptions[3];
        for (int i = 0; i < 3; i++) {
            int cardIndex = rand() % 7;
            selectedCards[i] = cardDeck[cardIndex];
            selectedDescriptions[i] = cardNames[cardIndex];
        }

        selectCard(player, selectedCards, selectedDescriptions);

        player->currentFloor++;
    }

    if (player->currentFloor > MAX_FLOORS) {
        printf("????????! ??? ?????? ??????????!\n");
    }
    else {
        printf("?????? ???????????. ??? ???????????!\n");
    }
}

int main() {
    srand(time(NULL));

    int choice;
    Player player;

    while (1) {
        system("cls"); // ??? ??? ????? (Windows ????)
        showMainMenu();
        scanf_s("%d", &choice);

        while (getchar() != '\n');

        if (choice == 1) {
            player.currentWeight = MAX_WEIGHT;
            player.currentFloor = 1;
            player.skipped = 0;
            player.effectFloor = 0;
            player.weightChange = 0;
            player.previousEffectFloor = 0;

            playGame(&player);
            printf("??? ??? ???? ???? ??????? ?????????...\n");
            (void)getchar(); // ????? ????
        }
        else if (choice == 2) {
            showRules();
        }
        else if (choice == 3) {
            printf("?????? ????????.\n");
            break;
        }
        else {
            printf("????? ????????. ??? ????????.\n");
            (void)getchar(); // ????? ????
        }
    }

    return 0;
}